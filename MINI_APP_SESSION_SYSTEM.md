# Система сессий для Telegram Mini App

## Обзор изменений

Реализована система управления сессиями для Telegram Mini App с автоматическим истечением через 2 часа и редиректом на Google.

## Что было сделано

### 1. Frontend изменения

#### `/frontend/src/utils/sessionStorage.ts` (новый файл)
Утилита для управления сессиями с функциями:
- `saveSession(userId, token?)` - сохранение сессии с временем истечения 2 часа
- `getSession()` - получение текущей сессии (null если истекла)
- `hasValidSession()` - проверка наличия валидной сессии
- `clearSession()` - очистка сессии
- `getRemainingTime()` - получение оставшегося времени сессии
- `extendSession()` - продление сессии на 2 часа

#### `/frontend/src/MiniApp.tsx`
Обновлена логика проверки сессий:
- При первом открытии через Telegram (есть `initData`) - разрешает верификацию
- При перезагрузке страницы (нет Telegram контекста):
  - Проверяет наличие валидной сессии
  - Если сессия истекла - редирект на Google
  - Если сессия валидна - открывает страницу поиска

#### `/frontend/src/pages/MiniAppUserSearch.tsx`
- Проверка существующей сессии при монтировании компонента
- Сохранение сессии после успешной верификации через Telegram
- Пропуск верификации если есть валидная сессия

#### `/frontend/src/types/mini-app.ts`
Добавлено поле `session_token?: string` в интерфейс `TelegramUserVerifyResponse`

### 2. Backend изменения

#### `/backend/app/schemas/mini_app.py`
Добавлено поле `session_token: Optional[str]` в схему `TelegramUserVerifyResponse`

#### `/backend/app/services/mini_app.py`
- Добавлена функция `_generate_session_token(user_id)` для генерации уникального токена сессии
- Обновлен метод `verify_telegram_user()` для возврата `session_token` при успешной верификации
- Токен генерируется как для существующих, так и для новых пользователей

## Как это работает

### Сценарий 1: Первое открытие Mini App из Telegram
1. Пользователь открывает Mini App через Telegram
2. `MiniApp.tsx` обнаруживает наличие `Telegram.WebApp.initData`
3. Разрешает загрузку `MiniAppUserSearch`
4. `MiniAppUserSearch` отправляет `initData` на backend для верификации
5. Backend проверяет данные и возвращает `session_token`
6. Frontend сохраняет сессию в `localStorage` со временем истечения через 2 часа
7. Пользователь получает доступ к функционалу поиска

### Сценарий 2: Перезагрузка страницы в течение 2 часов
1. Пользователь перезагружает страницу (F5)
2. `MiniApp.tsx` обнаруживает отсутствие Telegram контекста
3. Проверяет `localStorage` на наличие валидной сессии
4. Находит сессию, которая еще не истекла
5. Сразу показывает страницу поиска без повторной верификации
6. `MiniAppUserSearch` проверяет сессию и пропускает верификацию

### Сценарий 3: Перезагрузка страницы после истечения 2 часов
1. Пользователь перезагружает страницу спустя 2+ часа
2. `MiniApp.tsx` обнаруживает отсутствие Telegram контекста
3. Проверяет `localStorage` и находит истекшую сессию
4. Очищает истекшую сессию
5. Показывает сообщение "Сессия истекла"
6. Выполняет редирект на `https://www.google.com`

## Время жизни сессии

- **Длительность**: 2 часа (7200 секунд)
- **Хранение**: `localStorage` браузера
- **Ключ**: `miniapp_session`
- **Формат данных**:
```json
{
  "userId": 123456789,
  "verified": true,
  "token": "session_token_from_backend",
  "expiresAt": 1699456789000,
  "createdAt": 1699449589000
}
```

## Безопасность

1. **Токен сессии** генерируется на backend с использованием:
   - User ID
   - Случайные 32 байта (hex)
   - SHA256 хеш

2. **Проверка initData** на backend:
   - HMAC-SHA256 верификация
   - Проверка hash из Telegram
   - Защита от подделки данных

3. **Автоматическое истечение**:
   - Сессия автоматически удаляется через 2 часа
   - Проверка времени при каждом обращении к `getSession()`

## Логирование

Все ключевые операции логируются в консоль браузера с префиксами:
- `[SessionStorage]` - операции с сессией
- `[MiniApp]` - проверка и управление сессией
- `[MiniAppUserSearch]` - верификация пользователя

## Возможные улучшения

1. **Backend валидация токена** - добавить проверку `session_token` на backend
2. **Refresh token** - механизм обновления истекающей сессии
3. **Множественные устройства** - хранение активных сессий в БД
4. **Graceful expiration** - предупреждение за 5 минут до истечения сессии
5. **Custom redirect URL** - настраиваемый URL для редиректа вместо Google

## Тестирование

Для тестирования:

1. **Первое открытие**: Откройте Mini App через Telegram
2. **Перезагрузка**: Нажмите F5 - должна остаться на странице
3. **Истечение**: Измените `SESSION_DURATION` в `sessionStorage.ts` на 10 секунд, подождите, перезагрузите
4. **Проверка данных**: Откройте DevTools → Application → Local Storage → проверьте ключ `miniapp_session`

## Зависимости

Новые зависимости не добавлялись. Используются только встроенные:
- Frontend: `localStorage` API
- Backend: `hashlib`, `secrets` (стандартная библиотека Python)
