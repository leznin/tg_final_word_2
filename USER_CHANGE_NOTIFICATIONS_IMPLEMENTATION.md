# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏, —Ñ–∞–º–∏–ª–∏–∏ –∏ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—ã, –≥–¥–µ:
- –ë–æ—Ç —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º
- –§—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–∫–ª—é—á–µ–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–∞)

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª**: `backend/alembic/versions/28933715f49c_add_notify_on_user_changes_to_chats.py`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è `notify_on_user_changes` –≤ —Ç–∞–±–ª–∏—Ü—É `chats`
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–Ω–∞—á–µ–Ω–∏–µ `True`

**–§–∞–π–ª**: `backend/app/models/chats.py`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ: `notify_on_user_changes = Column(Boolean, default=True, nullable=False)`

### 2. –°–µ—Ä–≤–∏—Å—ã

**–§–∞–π–ª**: `backend/app/services/telegram_users.py`
- –ò–∑–º–µ–Ω–µ–Ω –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: `__init__(self, db: AsyncSession, bot=None)`
- –ú–µ—Ç–æ–¥ `_record_history_change` —Ç–µ–ø–µ—Ä—å:
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ bot instance
  - –í—ã–∑—ã–≤–∞–µ—Ç `UserChangeNotificationService` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª**: `backend/app/telegram/services/user_change_notifications.py` (–Ω–æ–≤—ã–π)
- –ö–ª–∞—Å—Å `UserChangeNotificationService`:
  - `notify_user_changes()` - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—ã
  - `toggle_notifications()` - –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  - `get_notification_status()` - –ø–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
  - `_format_notification_message()` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–§–∞–π–ª**: `backend/app/services/user_verification.py`
- –û–±–Ω–æ–≤–ª–µ–Ω –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: –ø–µ—Ä–µ–¥–∞–µ—Ç bot –≤ `TelegramUserService(db, bot)`

**–§–∞–π–ª**: `backend/app/services/chat_members.py`
- –ú–µ—Ç–æ–¥ `create_or_update_member_from_telegram()` —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `bot`
- –ü–µ—Ä–µ–¥–∞–µ—Ç bot –≤ `TelegramUserService(self.db, bot)`

### 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Telegram

**–§–∞–π–ª**: `backend/app/telegram/handlers/chat_member_updates.py`
- –ü–µ—Ä–µ–¥–∞–µ—Ç bot –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ `TelegramUserService(db, bot)`
- –ü–µ—Ä–µ–¥–∞–µ—Ç bot –≤ `member_service.create_or_update_member_from_telegram(chat.id, telegram_user_data, bot)`

**–§–∞–π–ª**: `backend/app/telegram/handlers/messages.py`
- `handle_edited_message()`: –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
- `handle_new_message()`: –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –û–±–∞ –º–µ—Ç–æ–¥–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `bot`

**–§–∞–π–ª**: `backend/app/telegram/handlers/chat_management.py`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã:
  - `handle_user_change_notifications_settings()` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  - `handle_toggle_user_notifications()` - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### 4. UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**–§–∞–π–ª**: `backend/app/telegram/utils/constants.py`
- –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å `UserChangeNotificationMessages` —Å —Ç–µ–∫—Å—Ç–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞: `USER_CHANGE_NOTIFICATIONS = "üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"`

**–§–∞–π–ª**: `backend/app/telegram/keyboards/chat_management.py`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_user_change_notifications_keyboard()` - –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_back_to_chat_actions_keyboard()` - –∫–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
- –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `get_chat_actions_keyboard()`

### 5. API –∏ —Å—Ö–µ–º—ã

**–§–∞–π–ª**: `backend/app/schemas/chats.py`
- `ChatBase`: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `notify_on_user_changes: bool = True`
- `ChatUpdate`: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `notify_on_user_changes: Optional[bool] = None`

### 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª**: `backend/test_user_change_notification.py` (–Ω–æ–≤—ã–π)
- –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–§–∞–π–ª**: `TESTING_USER_NOTIFICATIONS.md` (–Ω–æ–≤—ã–π)
- –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

## –ú–æ–º–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:

1. **–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É** (`handle_new_message()`)
2. **–ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è** (`handle_edited_message()`)
3. **–ü—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∫ –≥—Ä—É–ø–ø–µ** (`handle_chat_member_update()`)
4. **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏** (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:
1. –°—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
2. –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è - –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `telegram_user_history`
3. –ï—Å–ª–∏ bot instance –¥–æ—Å—Ç—É–ø–µ–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã

## –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```
üîî User Profile Changed

User: [Link to user]
First Name:
  Was: Ivan
  Now: Ivan_NEW

```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–µ–π

### –ß–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞:
1. "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏" 
2. –í—ã–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—É
3. "üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
4. "‚úÖ –í–∫–ª—é—á–∏—Ç—å" –∏–ª–∏ "‚ùå –í—ã–∫–ª—é—á–∏—Ç—å"

### –ß–µ—Ä–µ–∑ API:
```http
PATCH /api/chats/{chat_id}
Content-Type: application/json

{
  "notify_on_user_changes": true/false
}
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:
- `[USER_CHANGE]` - –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `[NOTIFY]` - –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:
```
[USER_CHANGE] User 123456: first_name changed from '–ò–≤–∞–Ω' to '–ò–≤–∞–Ω_NEW'
[USER_CHANGE] Bot instance available, sending notifications...
[NOTIFY] Starting notification process for user 123456, field first_name
[NOTIFY] User found: –ò–≤–∞–Ω_NEW
[NOTIFY] Found 2 chats where user is active member and notifications enabled
[NOTIFY] Sending to chat -1001234567890 (Test Group)
[NOTIFY] Successfully sent to chat -1001234567890
```
